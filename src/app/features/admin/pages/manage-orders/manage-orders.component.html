<div class="max-w-7xl mx-auto py-6 px-4">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Gestionar Pedidos</h1>

    <!-- Filtro por estado -->
    <div class="flex items-center gap-2">
      <label class="text-sm text-gray-600">Filtrar:</label>
      <select [value]="statusFilter()" (change)="onFilterChange($any($event.target).value)"
        class="border rounded px-3 py-2">
        <option value="ALL">Todos</option>
        <option [value]="OrderStatus.PENDING">Pendientes</option>
        <option [value]="OrderStatus.PREPARING">En preparaci√≥n</option>
        <option [value]="OrderStatus.DELIVERED">Entregados</option>
        <option [value]="OrderStatus.CANCELLED">Cancelados</option>
      </select>
    </div>
  </div>

  <!-- Error State -->
  @if (error()) {
  <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
    <p class="text-red-600">{{ error() }}</p>
    <button (click)="loadOrders()" class="mt-2 text-sm text-red-700 underline">
      Reintentar
    </button>
  </div>
  }

  <!-- Loading State -->
  @if (loading()) {
  <div class="flex justify-center py-12">
    <p class="text-gray-500">Cargando pedidos...</p>
  </div>
  }

  <!-- Orders Table -->
  @if (!loading()) {
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <table class="table-auto w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ID</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Usuario</th>
          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Fecha</th>
          <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Estado</th>
          <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Total</th>
          <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (order of filteredOrders(); track order.id) {
        <tr class="border-t border-gray-100 hover:bg-gray-50">
          <td class="px-4 py-3 text-sm text-gray-600">#{{ order.id | slice:0:8 }}</td>
          <td class="px-4 py-3 text-sm text-gray-600">{{ order.userEmail || order.userId }}</td>
          <td class="px-4 py-3 text-sm text-gray-600">
            {{ order.createdAt | date:'dd/MM/yyyy HH:mm' }}
          </td>
          <td class="px-4 py-3 text-center">
            <span class="px-2 py-1 rounded-full text-sm" [class]="getStatusClass(order.status)">
              {{ getStatusLabel(order.status) }}
            </span>
          </td>
          <td class="px-4 py-3 text-right text-sm font-semibold text-gray-900">
            {{ order.total | currency:'COP':'symbol-narrow':'1.0-0' }}
          </td>
          <td class="px-4 py-3 text-center">
            <button (click)="openOrderDetail(order)"
              class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">
              Ver detalle
            </button>
          </td>
        </tr>
        } @empty {
        <tr>
          <td colspan="6" class="px-4 py-8 text-center text-gray-500">
            No hay pedidos {{ statusFilter() !== 'ALL' ? 'con este estado' : '' }}
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  }

  <!-- Order Detail Modal -->
  @if (selectedOrder()) {
  <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-start mb-4">
        <h3 class="text-lg font-semibold text-gray-900">
          Pedido #{{ selectedOrder()!.id | slice:0:8 }}
        </h3>
        <button (click)="closeOrderDetail()" class="text-gray-400 hover:text-gray-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Order Info -->
      <div class="grid grid-cols-2 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
        <div>
          <p class="text-sm text-gray-500">Usuario</p>
          <p class="font-semibold">{{ selectedOrder()!.userEmail || selectedOrder()!.userId }}</p>
        </div>
        <div>
          <p class="text-sm text-gray-500">Fecha</p>
          <p class="font-semibold">{{ selectedOrder()!.createdAt | date:'dd/MM/yyyy HH:mm' }}</p>
        </div>
        <div>
          <p class="text-sm text-gray-500">Estado Actual</p>
          <span class="inline-block px-2 py-1 rounded-full text-sm mt-1"
            [class]="getStatusClass(selectedOrder()!.status)">
            {{ getStatusLabel(selectedOrder()!.status) }}
          </span>
        </div>
        <div>
          <p class="text-sm text-gray-500">Total</p>
          <p class="font-bold text-blue-600">
            {{ selectedOrder()!.total | currency:'COP':'symbol-narrow':'1.0-0' }}
          </p>
        </div>
      </div>

      <!-- Order Items -->
      <h4 class="font-semibold text-gray-900 mb-2">Productos</h4>
      <table class="table-auto w-full mb-6 text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-3 py-2 text-left">Producto</th>
            <th class="px-3 py-2 text-center">Cantidad</th>
            <th class="px-3 py-2 text-right">Precio</th>
            <th class="px-3 py-2 text-right">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          @for (item of selectedOrder()!.items; track item.productId) {
          <tr class="border-t">
            <td class="px-3 py-2">{{ item.product?.name || item.productName || item.productId }}</td>
            <td class="px-3 py-2 text-center">{{ item.quantity }}</td>
            <td class="px-3 py-2 text-right">
              {{ item.price | currency:'COP':'symbol-narrow':'1.0-0' }}
            </td>
            <td class="px-3 py-2 text-right font-semibold">
              {{ (item.price * item.quantity) | currency:'COP':'symbol-narrow':'1.0-0' }}
            </td>
          </tr>
          }
        </tbody>
      </table>

      <!-- Change Status -->
      <div class="border-t pt-4">
        <h4 class="font-semibold text-gray-900 mb-3">Cambiar Estado</h4>
        <div class="flex items-center gap-4">
          <select [(ngModel)]="newStatus" class="border rounded px-3 py-2 flex-1">
            @for (status of statusOptions; track status) {
            <option [ngValue]="status">{{ getStatusLabel(status) }}</option>
            }
          </select>
          <button (click)="updateOrderStatus()" [disabled]="updatingStatus() || newStatus() === selectedOrder()!.status"
            class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 disabled:bg-gray-300">
            @if (updatingStatus()) {
            Actualizando...
            } @else {
            Actualizar
            }
          </button>
        </div>
      </div>
    </div>
  </div>
  }
</div>